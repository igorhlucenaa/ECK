<div class="container mt-4">
  <ng-container *ngIf="isEmailSendingMode; else defaultMode">
    <!-- Modo de Envio de E-mails -->
    <h2 mat-dialog-title>Selecionar Destinatários para Envio de E-mails</h2>
    <div mat-dialog-content>
      <div class="row mb-3" style="margin-top: 20px">
        <div class="col-md-3">
          <mat-form-field class="w-100" appearance="outline">
            <mat-label>Cliente</mat-label>
            <mat-select [(ngModel)]="filterClient" [disabled]="true">
              <mat-option *ngFor="let client of clients" [value]="client.id">
                {{ client.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-md-3">
          <mat-form-field class="w-100" appearance="outline">
            <mat-label>Selecione o Projeto</mat-label>
            <mat-select
              [(ngModel)]="filterProject"
              (ngModelChange)="onProjectChange()"
              [disabled]="true"
            >
              <mat-option value="">Selecione um projeto</mat-option>
              <mat-option
                *ngFor="let project of filteredProjects"
                [value]="project.id"
              >
                {{ project.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-md-3">
          <mat-form-field class="w-100" appearance="outline">
            <mat-label>Modelo de e-mail</mat-label>
            <mat-select [formControl]="templateFormControl" [disabled]="true">
              <mat-option
                *ngFor="let template of mailTemplates"
                [value]="template.id"
              >
                {{ template.name }} -
                <strong>{{ getFriendlyEmailType(template.emailType) }}</strong>
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div
          class="col-md-3"
          *ngIf="
            emailType &&
            [
              'conviteAvaliador',
              'conviteRespondente',
              'lembreteAvaliador',
              'lembreteRespondente',
              'convite',
              'lembrete'
            ].includes(emailType)
          "
        >
          <mat-form-field class="w-100" appearance="outline">
            <mat-label>Selecione a Avaliação</mat-label>
            <mat-select [formControl]="assessmentFormControl" required>
              <mat-option
                *ngFor="let assessment of assessments"
                [value]="assessment.id"
              >
                {{ assessment.name }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="assessmentFormControl.hasError('required')">
              Por favor, selecione uma avaliação.
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <mat-form-field class="w-100" appearance="outline">
            <mat-label>Buscar por Nome ou E-mail</mat-label>
            <input
              matInput
              [(ngModel)]="searchValue"
              (ngModelChange)="applyFilter()"
            />
            <button
              mat-icon-button
              matSuffix
              *ngIf="searchValue"
              (click)="searchValue = ''; applyFilter()"
            >
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>
        <div class="col-md-3">
          <mat-form-field class="w-100" appearance="outline">
            <mat-label>Filtrar por Categoria</mat-label>
            <mat-select
              [(ngModel)]="filterCategory"
              (ngModelChange)="applyFilter()"
            >
              <mat-option value="">Todos</mat-option>
              <mat-option value="Avaliado">Avaliado</mat-option>
              <mat-option value="Gestor">Gestor</mat-option>
              <mat-option value="Par">Par</mat-option>
              <mat-option value="Subordinado">Subordinado</mat-option>
              <mat-option value="Outros">Outros</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-md-3">
          <mat-form-field class="w-100" appearance="outline">
            <mat-label>Filtrar por Status</mat-label>
            <mat-select
              [(ngModel)]="filterStatus"
              (ngModelChange)="applyFilter()"
            >
              <mat-option value="">Todos</mat-option>
              <mat-option value="Não Enviado">Não Enviado</mat-option>
              <mat-option value="Enviado (Pendente)"
                >Enviado (Pendente)</mat-option
              >
              <mat-option value="Respondido">Respondido</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div *ngIf="isTableLoading" class="text-center my-4">
        <mat-spinner [diameter]="50"></mat-spinner>
        <p>Carregando participantes...</p>
      </div>

      <div
        class="table-responsive"
        [hidden]="isTableLoading || dataSource.data.length === 0"
      >
        <table
          mat-table
          [dataSource]="dataSource"
          matSort
          class="mat-elevation-z8 w-100"
        >
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox
                (change)="toggleAll($event.checked)"
                [checked]="allSelected()"
                [indeterminate]="someSelected() && !allSelected()"
              ></mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let participant">
              <mat-checkbox
                [(ngModel)]="participant.selected"
                (ngModelChange)="updateSelection()"
                [disabled]="
                  participant.completedAt != null ||
                  (emailType === 'conviteAvaliador' ||
                  emailType === 'lembreteAvaliador'
                    ? participant.type !== 'avaliador'
                    : emailType === 'cadastro'
                    ? false
                    : participant.type !== 'avaliado')
                "
              ></mat-checkbox>
            </td>
          </ng-container>
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Nome</th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.name }}
            </td>
          </ng-container>
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>E-mail</th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.email }}
            </td>
          </ng-container>
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.type }}
            </td>
          </ng-container>
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoria</th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.category }}
            </td>
          </ng-container>
          <ng-container matColumnDef="projectName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Projeto</th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.projectName || "N/A" }}
            </td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.status || "N/A" }}
            </td>
          </ng-container>
          <ng-container matColumnDef="sentAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Data de Envio
            </th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.sentAt | date : "short" }}
            </td>
          </ng-container>
          <ng-container matColumnDef="completedAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Data de Resposta
            </th>
            <td mat-cell *matCellDef="let participant">
              {{ participant.completedAt | date : "short" }}
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
        <mat-paginator
          [pageSize]="10"
          [pageSizeOptions]="[5, 10, 20, 50]"
          showFirstLastButtons
        ></mat-paginator>
      </div>
    </div>

    <div mat-dialog-actions class="mt-3 text-end">
      <button mat-button (click)="dialogRef.close()">Cancelar</button>
      <button
        mat-flat-button
        color="primary"
        (click)="resendLinks()"
        [disabled]="
          isLoading ||
          selectedParticipants.length === 0 ||
          (emailType &&
            [
              'conviteAvaliador',
              'conviteRespondente',
              'lembreteAvaliador',
              'lembreteRespondente',
              'convite',
              'lembrete'
            ].includes(emailType) &&
            !assessmentFormControl.valid)
        "
      >
        <mat-spinner *ngIf="isLoading" [diameter]="20"></mat-spinner>
        <span *ngIf="isLoading">Enviando...</span>
        <span *ngIf="!isLoading">Enviar E-mails</span>
      </button>
    </div>
  </ng-container>

  <ng-template #defaultMode>
    <h2>Lista de Participantes</h2>

    <div class="d-flex justify-content-between mb-3">
      <div>
        <button
          mat-raised-button
          color="primary"
          (click)="downloadTemplate()"
          style="margin-right: 10px"
        >
          <mat-icon>download</mat-icon> Baixar Planilha de Modelo
        </button>
        <button mat-raised-button color="accent" style="margin-right: 10px">
          <label for="uploadExcel" class="btn btn-secondary">
            <mat-icon>upload_file</mat-icon> Carregar Arquivo Excel
          </label>
          <input
            id="uploadExcel"
            type="file"
            accept=".xlsx, .xls"
            style="display: none"
            (change)="uploadExcel($event)"
          />
        </button>
        <button
          mat-flat-button
          color="primary"
          (click)="openAddParticipantModal()"
        >
          Adicionar Novo Participante
        </button>
      </div>
    </div>

    <div class="row mb-4" style="margin-top: 40px">
      <div class="col-md-12">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Buscar por Nome ou E-mail</mat-label>
          <input
            matInput
            [(ngModel)]="searchValue"
            (ngModelChange)="applyFilter()"
          />
          <button
            mat-icon-button
            matSuffix
            *ngIf="searchValue"
            (click)="searchValue = ''; applyFilter()"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>
      <div class="col-md-3">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Selecione o Cliente</mat-label>
          <mat-select
            [(ngModel)]="filterClient"
            (ngModelChange)="onClientChange()"
            [disabled]="isClientDisabled"
          >
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let client of clients" [value]="client.id">{{
              client.name
            }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col-md-3">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Selecione o Projeto</mat-label>
          <mat-select
            [(ngModel)]="filterProject"
            (ngModelChange)="onProjectChange()"
            [disabled]="isProjectDisabled || !filterClient"
          >
            <mat-option value="">Todos</mat-option>
            <mat-option
              *ngFor="let project of filteredProjects"
              [value]="project.id"
              >{{ project.name }}</mat-option
            >
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col-md-3">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Selecione um Modelo de e-mail</mat-label>
          <mat-select
            [formControl]="templateFormControl"
            required
            (selectionChange)="onTemplateChange()"
          >
            <mat-option
              *ngFor="let template of mailTemplates"
              [value]="template.id"
            >
              {{ template.name }} -
              <strong>{{ getFriendlyEmailType(template.emailType) }}</strong>
            </mat-option>
          </mat-select>
          <mat-error *ngIf="templateFormControl.hasError('required')"
            >Por favor, selecione um template.</mat-error
          >
        </mat-form-field>
      </div>
      <div class="col-md-3">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Selecione um Formulário de Avaliação</mat-label>
          <mat-select
            [formControl]="assessmentFormControl"
            required
            [disabled]="
              !selectedTemplate?.emailType ||
              selectedTemplate?.emailType === 'cadastro'
            "
          >
            <mat-option
              *ngFor="let assessment of assessments"
              [value]="assessment.id"
            >
              {{ assessment.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="assessmentFormControl.hasError('required')"
            >Por favor, selecione uma avaliação.</mat-error
          >
        </mat-form-field>
      </div>
    </div>

    <hr style="border: 1px solid #ccc; margin-bottom: 40px" />

    <div class="row mb-4" style="margin-top: 40px">
      <div class="col-md-4">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Filtrar por Tipo</mat-label>
          <mat-select [(ngModel)]="filterType" (ngModelChange)="applyFilter()">
            <mat-option value="">Todos</mat-option>
            <mat-option value="avaliado">Avaliado</mat-option>
            <mat-option value="avaliador">Avaliador</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col-md-4">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Filtrar por Categoria</mat-label>
          <mat-select
            [(ngModel)]="filterCategory"
            (ngModelChange)="applyFilter()"
          >
            <mat-option value="">Todos</mat-option>
            <mat-option value="Avaliado">Avaliado</mat-option>
            <mat-option value="Gestor">Gestor</mat-option>
            <mat-option value="Par">Par</mat-option>
            <mat-option value="Subordinado">Subordinado</mat-option>
            <mat-option value="Outros">Outros</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col-md-4">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Filtrar por Status</mat-label>
          <mat-select
            [(ngModel)]="filterStatus"
            (ngModelChange)="applyFilter()"
          >
            <mat-option value="">Todos</mat-option>
            <mat-option value="Não Enviado">Não Enviado</mat-option>
            <mat-option value="Enviado (Pendente)"
              >Enviado (Pendente)</mat-option
            >
            <mat-option value="Respondido">Respondido</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div
      *ngIf="!isTableLoading && dataSource.data.length === 0"
      class="text-center my-4"
    >
      <p>Nenhum participante encontrado.</p>
    </div>

    <div *ngIf="isTableLoading" class="text-center my-4">
      <mat-spinner [diameter]="50"></mat-spinner>
      <p>Carregando participantes...</p>
    </div>

    <div
      class="table-responsive"
      [hidden]="isTableLoading || dataSource.data.length === 0"
    >
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        class="mat-elevation-z8 w-100"
      >
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="toggleAll($event.checked)"
              [checked]="allSelected()"
              [indeterminate]="someSelected() && !allSelected()"
            ></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let participant">
            <mat-checkbox
              [(ngModel)]="participant.selected"
              (ngModelChange)="updateSelection()"
              [disabled]="
                participant.completedAt != null ||
                (selectedTemplate?.emailType === 'conviteAvaliador' ||
                selectedTemplate?.emailType === 'lembreteAvaliador'
                  ? participant.type !== 'avaliador'
                  : selectedTemplate?.emailType === 'cadastro'
                  ? false
                  : participant.type !== 'avaliado')
              "
            ></mat-checkbox>
          </td>
        </ng-container>
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nome</th>
          <td mat-cell *matCellDef="let participant">{{ participant.name }}</td>
        </ng-container>
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>E-mail</th>
          <td mat-cell *matCellDef="let participant">
            {{ participant.email }}
          </td>
        </ng-container>
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
          <td mat-cell *matCellDef="let participant">{{ participant.type }}</td>
        </ng-container>
        <ng-container matColumnDef="category">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoria</th>
          <td mat-cell *matCellDef="let participant">
            {{ participant.category }}
          </td>
        </ng-container>
        <ng-container matColumnDef="projectName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Projeto</th>
          <td mat-cell *matCellDef="let participant">
            {{ participant.projectName || "N/A" }}
          </td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let participant">
            {{ participant.status || "N/A" }}
          </td>
        </ng-container>
        <ng-container matColumnDef="sentAt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            Data de Envio
          </th>
          <td mat-cell *matCellDef="let participant">
            {{ participant.sentAt | date : "short" }}
          </td>
        </ng-container>
        <ng-container matColumnDef="completedAt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            Data de Resposta
          </th>
          <td mat-cell *matCellDef="let participant">
            {{ participant.completedAt | date : "short" }}
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      <mat-paginator
        [pageSize]="10"
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons
      ></mat-paginator>
    </div>

    <div class="mt-3 text-end" *ngIf="dataSource.data.length > 0">
      <button
        mat-button
        (click)="resendLinks()"
        [disabled]="
          isLoading ||
          selectedParticipants.length === 0 ||
          !templateFormControl.valid ||
          (selectedTemplate?.emailType &&
            [
              'conviteAvaliador',
              'conviteRespondente',
              'lembreteAvaliador',
              'lembreteRespondente',
              'convite',
              'lembrete'
            ].includes(selectedTemplate?.emailType) &&
            !assessmentFormControl.valid)
        "
      >
        <mat-spinner *ngIf="isLoading" [diameter]="20"></mat-spinner>
        <span *ngIf="isLoading">Enviando...</span>
        <span *ngIf="!isLoading">Enviar Links</span>
      </button>
      <button mat-button (click)="dialogRef.close()">Fechar</button>
    </div>
  </ng-template>
</div>
