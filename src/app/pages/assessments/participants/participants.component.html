<div class="container mt-4">
  <div class="mt-4" style="margin-bottom: 15px">
    <button
      mat-raised-button
      color="primary"
      (click)="downloadTemplate()"
      style="margin-right: 10px"
    >
      <mat-icon>download</mat-icon> Baixar Planilha de Modelo
    </button>

    <!-- Botão estilizado para upload -->
    <button mat-raised-button color="accent">
      <label for="uploadExcel" class="btn btn-secondary mt-3">
        <mat-icon>upload_file</mat-icon> Carregar Arquivo Excel
      </label>
      <input
        id="uploadExcel"
        type="file"
        accept=".xlsx, .xls"
        style="display: none"
        (change)="uploadExcel($event)"
      />
    </button>
  </div>

  <mat-tab-group>
    <!-- Tabela de Avaliadores -->
    <mat-tab label="Avaliadores">
      <div class="mt-4">
        <!-- Filtros -->
        <div class="row mb-3" style="margin-top: 20px">
          <div class="col-md-6">
            <mat-form-field class="w-100">
              <mat-label>Buscar</mat-label>
              <input
                matInput
                (keyup)="applyFilter($event, 'evaluators')"
                placeholder="Digite para buscar"
              />
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field class="w-100">
              <mat-label>Filtrar por Categoria</mat-label>
              <mat-select
                (selectionChange)="
                  filterTable('evaluators', { category: $event.value })
                "
              >
                <mat-option value="">Todos</mat-option>
                <mat-option value="gestor">Gestor</mat-option>
                <mat-option value="par">Par</mat-option>
                <mat-option value="subordinado">Subordinado</mat-option>
                <mat-option value="outros">Outros</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <table
          mat-table
          [dataSource]="evaluatorsDataSource"
          matSort
          #evaluatorsSort="matSort"
          class="mat-elevation-z8"
        >
          <!-- Seleção -->
          <!-- <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox
                (change)="selectAll('evaluators', $event)"
              ></mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let evaluator">
              <mat-checkbox
                (change)="toggleSelection('evaluators', evaluator)"
                [checked]="evaluator.selected"
              ></mat-checkbox>
            </td>
          </ng-container> -->

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Nome</th>
            <td mat-cell *matCellDef="let evaluator">{{ evaluator.name }}</td>
          </ng-container>

          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
            <td mat-cell *matCellDef="let evaluator">{{ evaluator.email }}</td>
          </ng-container>

          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoria</th>
            <td mat-cell *matCellDef="let evaluator">
              {{ evaluator.category }}
            </td>
          </ng-container>

          <ng-container matColumnDef="assessments">
            <th mat-header-cell *matHeaderCellDef>Avaliações</th>
            <td mat-cell *matCellDef="let evaluator">
              <div *ngIf="evaluator.isEditing; else viewMode">
                <mat-form-field class="w-100">
                  <mat-label>Selecione as avaliações</mat-label>
                  <mat-select [(ngModel)]="evaluator.assessments" multiple>
                    <mat-option
                      *ngFor="let assessment of availableAssessments"
                      [value]="assessment.id"
                    >
                      {{ assessment.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <button
                  mat-icon-button
                  color="primary"
                  (click)="saveAssessments(evaluator)"
                >
                  <mat-icon>check</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="cancelEdit(evaluator)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <ng-template #viewMode>
                <span
                  *ngIf="
                    (evaluator.assessments?.length ?? 0) > 0;
                    else noAssessments
                  "
                >
                  {{ getAssessmentNames(evaluator.assessments) }}
                </span>
                <ng-template #noAssessments>
                  <span>Sem avaliações</span>
                </ng-template>
                <button
                  mat-icon-button
                  color="primary"
                  (click)="editAssessments(evaluator)"
                >
                  <mat-icon>edit</mat-icon>
                </button>
              </ng-template>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Ações</th>
            <td mat-cell *matCellDef="let evaluator">
              <button
                mat-icon-button
                color="warn"
                (click)="deleteEvaluator(evaluator)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="evaluatorsDisplayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: evaluatorsDisplayedColumns"
          ></tr>
        </table>
        <mat-paginator
          #evaluatorsPaginator
          [pageSize]="5"
          [pageSizeOptions]="[5, 10, 25]"
          showFirstLastButtons
        ></mat-paginator>
      </div>
    </mat-tab>

    <!-- Tabela de Avaliados -->
    <mat-tab label="Avaliados">
      <div class="mt-4">
        <!-- Filtros -->
        <div class="row mb-3" style="margin-top: 20px">
          <div class="col-md-6">
            <mat-form-field class="w-100">
              <mat-label>Buscar</mat-label>
              <input
                matInput
                (keyup)="applyFilter($event, 'evaluatees')"
                placeholder="Digite para buscar"
              />
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field class="w-100">
              <mat-label>Filtrar por Categoria</mat-label>
              <mat-select
                (selectionChange)="
                  filterTable('evaluatees', { category: $event.value })
                "
              >
                <mat-option value="">Todos</mat-option>
                <mat-option value="gestor">Gestor</mat-option>
                <mat-option value="par">Par</mat-option>
                <mat-option value="subordinado">Subordinado</mat-option>
                <mat-option value="avaliado">Avaliado</mat-option>
                <mat-option value="outros">Outros</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <table
          mat-table
          [dataSource]="evaluateesDataSource"
          matSort
          #evaluateesSort="matSort"
          class="mat-elevation-z8"
        >
          <!-- Seleção -->
          <!-- <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox
                (change)="selectAll('evaluatees', $event)"
              ></mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let evaluatee">
              <mat-checkbox
                (change)="toggleSelection('evaluatees', evaluatee)"
                [checked]="evaluatee.selected"
              ></mat-checkbox>
            </td>
          </ng-container> -->

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Nome</th>
            <td mat-cell *matCellDef="let evaluatee">{{ evaluatee.name }}</td>
          </ng-container>

          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
            <td mat-cell *matCellDef="let evaluatee">{{ evaluatee.email }}</td>
          </ng-container>

          <ng-container matColumnDef="client">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
            <td mat-cell *matCellDef="let evaluatee">
              {{ evaluatee.clientName }}
            </td>
          </ng-container>

          <ng-container matColumnDef="project">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Projeto</th>
            <td mat-cell *matCellDef="let evaluatee">
              {{ evaluatee.projectName }}
            </td>
          </ng-container>

          <ng-container matColumnDef="assessments">
            <th mat-header-cell *matHeaderCellDef>Avaliações</th>
            <td mat-cell *matCellDef="let evaluatee">
              <!-- Apenas exibe e abre modal -->
              <ng-container
                *ngIf="
                  (evaluatee.assessments?.length ?? 0) > 0;
                  else noAssessments
                "
              >
                <a
                  href="javascript:void(0)"
                  (click)="showAssessmentsModal(evaluatee)"
                >
                  Ver Avaliações ({{ evaluatee.assessments.length }})
                </a>
              </ng-container>
              <ng-template #noAssessments>
                <span>Sem avaliações</span>
              </ng-template>
            </td>
          </ng-container>

          <ng-container matColumnDef="evaluators">
            <th mat-header-cell *matHeaderCellDef>Avaliadores</th>
            <td mat-cell *matCellDef="let evaluatee">
              <div *ngIf="evaluatee.isEditingEvaluators; else viewMode">
                <mat-form-field class="w-100">
                  <mat-label>Selecione os avaliadores</mat-label>
                  <mat-select [(ngModel)]="evaluatee.evaluators" multiple>
                    <mat-option
                      *ngFor="let evaluator of availableEvaluators"
                      [value]="evaluator.id"
                    >
                      {{ evaluator.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <button
                  mat-icon-button
                  color="primary"
                  (click)="saveEvaluateeEvaluators(evaluatee)"
                >
                  <mat-icon>check</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="cancelEvaluateeEvaluatorsEdit(evaluatee)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              <ng-template #viewMode>
                <ng-container
                  *ngIf="
                    (evaluatee.evaluators?.length ?? 0) > 0;
                    else noEvaluators
                  "
                >
                  <a
                    href="javascript:void(0)"
                    (click)="openEvaluatorsModal(evaluatee)"
                  >
                    Ver Avaliadores ({{ evaluatee.evaluators.length }})
                  </a>
                </ng-container>
                <ng-template #noEvaluators>
                  <span>Sem avaliadores</span>
                </ng-template>
                <button
                  mat-icon-button
                  color="primary"
                  (click)="editEvaluateeEvaluators(evaluatee)"
                >
                  <mat-icon>edit</mat-icon>
                </button>
              </ng-template>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Ações</th>
            <td mat-cell *matCellDef="let evaluatee">
              <button
                mat-icon-button
                color="warn"
                (click)="deleteEvaluatee(evaluatee)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="evaluateesDisplayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: evaluateesDisplayedColumns"
          ></tr>
        </table>
        <mat-paginator
          #evaluateesPaginator
          [pageSize]="5"
          [pageSizeOptions]="[5, 10, 25]"
          showFirstLastButtons
        ></mat-paginator>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
